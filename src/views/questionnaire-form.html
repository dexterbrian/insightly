<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../../output.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css"  rel="stylesheet" />
    <title>Questionnaire Form</title>
</head>
<body>

    <div class="text-center">
        <h2 class="text-4xl font-extrabold text-gray-900 dark:text-white m-6">Create or Edit a Questionnaire</h2>
    </div>

    <form id="questionnaire-form" method="post" class="max-w-sm mx-auto">
        <div class="mb-5">
            <label for="name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Your name</label>
            <input type="name" id="creator" name="creator" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="John Doe" required />
        </div>

        <div class="mb-5">
            <label for="title" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Title of your questionnaire</label>
            <input type="text" id="title" name="title" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Questionnaire Title" required />
        </div>

        <div id="questionsArea">
            <div id="question0">
                <div class="mb-5">
                    <label for="question" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Your Question</label>
                    <input type="text" id="question" name="question" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="What is 1 + 1?" required />
                </div>

                <div class="mb-5">
                    <label for="question" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Weight</label>
                    <input type="text" id="question" name="weight" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="1, 2 or 3?" required />
                </div>

                <div class="mb-5">
                    <label for="question" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Answer</label>
                    <input type="text" id="question" name="answer" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="What's the correct answer?" required />
                </div>

                <div class="mb-5">
                    <label for="choices" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Multiple Choices</label>
                    <div id="choices">
                        <input type="text" id="choice0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 mb-3" placeholder="Type in a choice" required />
                        <input type="text" id="choice1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 mb-3" placeholder="Type in a choice" required />
                        <input type="text" id="choice2" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 mb-3" placeholder="Type in a choice" required />
                    </div>
                    <button type="button" onclick="addChoice()" class="py-2.5 px-5 me-2 mt-2 mb-2 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">Add a choice</button>
                    <button type="button" onclick="removeChoice()" class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900">Remove Choice</button>
                </div>
            </div>
        </div>
            
        <button type="button" onclick="createQuestionnaire()" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Create</button>
        <button type="button" onclick="addQuestion()" class="py-2.5 px-5 me-2 mb-2 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">Add a question</button>
        <button type="button" onclick="removeQuestion()" class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900">Remove Question</button>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script type="text/javascript">

        var questionArea = document.getElementById('questionsArea'),
            lastQuestionIndex = 0;

        $(document).ready(function() {
            // Find out how many questions there are in the questionsArea div
            // Loop through each child element in the questions area and gather the data in the each input element in an object
            
            lastQuestionIndex = getLastQuestionIndex();

            // Store the lastQuestionIndex as 0 in storage
            localStorage.setItem('lastQuestionIndex', lastQuestionIndex);

            let creator = $("#creator").val(),
                title = $("#title").val()
            ;

            $('#creator').on('input', function() {
                creator = $(this).val();
            });
            $('#title').on('input', function() {
                title = $(this).val();
            });

            console.log('myobject: ', {creator, title});
            //addQuestion();
        });
        
        function getNumberOfQuestions() {
            questionsArea = document.getElementById("questionsArea");
            return questions.children.length;
        }

        function addChoice() {
            const choices = document.getElementById("choices");
            let choice = document.createElement("input");

            choice.type = "text";
            choice.name = "choices[]";
            choice.className = "bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 mb-3",
            choice.placeholder = "Type in a choice",
            choice.required = true;

            choices.appendChild(choice);
        }

        function removeChoice() {
            const choices = document.getElementById("choices");
            choices.removeChild(choices.lastElementChild);
        }

        function getLastQuestionIndex() {
            questionArea = document.getElementById('questionsArea');
            const lastQuestion = questionArea.lastElementChild;
            console.log('lastquestion: ', lastQuestion.id);

            for (i = 0; i < lastQuestion.id.length - 1; i++) {
                if (!Number.isNaN(lastQuestion.id[i])) {
                    continue;
                } else {
                    lastQuestionIndex = parseInt(lastQuestion.id.slice(i));
                    break;
                }
            }
            console.log('lastQuestionIndex: ', lastQuestionIndex);

            return lastQuestionIndex;
        }

        function addQuestion() {

            lastQuestionIndex = localStorage.getItem('lastQuestionIndex');

            lastQuestionIndex = parseInt(lastQuestionIndex) + 1;
            localStorage.setItem('lastQuestionIndex', lastQuestionIndex);
            console.log('nextQuestionIndex: ', lastQuestionIndex);

            // Clone the last question, change its id to the nextQuestionIndex and then add it to the questionsArea div
            const lastQuestion = questionArea.lastElementChild;
            const nextQuestion = lastQuestion.cloneNode(true);

            // Change the id of nextQuestion
            nextQuestion.id = 'question' + lastQuestionIndex.toString();

            lastQuestion.parentNode.appendChild(nextQuestion);
        }

        function removeQuestion() {
            const question = questionArea.lastElementChild;
            question.parentNode.removeChild(question);
        }

        /**
         * Get all the form data and send it to POST /api/questionnaires in this json form 
            {
                "creator": "Brian",
                "title": "Brian's Questionnaire",
                "questions": [
                    {
                        "question": "What is 1+1",
                        "choices": ["2", "3", "11"],
                        "answer": "2",
                        "weight": 1
                    },
                    {
                        "question": "What is 10+1",
                        "choices": ["11", "3", "101"],
                        "answer": "11",
                        "weight": 1
                    }
                ]
            }
        */
        function createQuestionnaire() {
            const form = document.getElementById('questionnaire-form');
            const formData = new FormData(form);

            console.log('formData: ', formData);

            const json = formDataToJson(formData);
            console.log('json: ', json);

            // fetch('/api/questionnaires', {
            //     method: 'POST',
            //     body: formData
            // })
            // .then(response => response.json())
            // .then(data => {
            //     console.log('Success:', data);
            // })
            // .catch((error) => {
            //     console.error('Error:', error);
            // });
        }

        function formDataToJson(formData) {
            const json = {};
            const questions = [];

            // Extract creator and title from form data
            json.creator = formData.creator;
            json.title = formData.title;

            // Extract questions from form data
            const questionCount = Object.keys(formData).filter(key => key.startsWith('question')).length;
            for (let i = 0; i < questionCount; i++) {
                const question = {};
                question.question = decodeURIComponent(formData[`question[${i}]`]);
                question.choices = formData[`choices[${i}]`].split(',');
                question.answer = formData[`answer[${i}]`];
                question.weight = formData[`weight[${i}]`];
                questions.push(question);
            }

            json.questions = questions;

            return json;
        }
    </script>
</body>
</html>